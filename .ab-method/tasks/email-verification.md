# Task: 邮箱验证与安全增强

## 概述
为现有认证系统添加邮箱验证功能，实现完整的注册验证和忘记密码流程。

## 技术方案
- **邮件服务**: Resend
- **验证方式**: 6位数字验证码
- **验证码有效期**: 10分钟
- **发送频率限制**: 60秒/次

## 数据库设计

```prisma
model EmailVerification {
  id        String   @id @default(cuid())
  email     String
  code      String   // 6位验证码
  type      String   // "register" | "reset_password"
  expires   DateTime // 10分钟后过期
  used      Boolean  @default(false)
  createdAt DateTime @default(now())

  @@index([email, code])
}
```

---

## Missions

### Mission 1: 集成 Resend 邮件服务 ✅
**预计时间**: 1-2小时
**目标**: 配置 Resend SDK 并创建邮件发送服务

**任务清单**:
- [x] 安装 resend 包到 packages/api
- [x] 创建 `packages/api/src/services/email.ts` 邮件服务
- [x] 实现 `sendVerificationCode()` 发送验证码邮件
- [x] 实现 `sendPasswordResetCode()` 发送重置密码邮件
- [x] 创建邮件模板（简洁的验证码样式）
- [x] 添加环境变量 `RESEND_API_KEY`
- [x] 更新 `CLAUDE.md` 文档

**验收标准**:
- 能通过 API 发送测试邮件
- 邮件内容清晰，包含验证码和有效期提示

---

### Mission 2: 邮箱验证 API 实现
**预计时间**: 2-3小时
**目标**: 实现注册验证码发送和验证的 API

**任务清单**:
- [ ] 添加 `EmailVerification` 模型到 Prisma schema
- [ ] 运行数据库迁移
- [ ] 创建 API: `auth.sendEmailCode` - 发送验证码
  - 验证邮箱格式
  - 60秒发送频率限制
  - 生成6位随机码，10分钟有效
  - 调用邮件服务发送
- [ ] 创建 API: `auth.verifyEmailCode` - 验证邮箱验证码
  - 校验验证码有效性
  - 成功后标记为已使用
- [ ] 修改 `auth.register` - 增加邮箱验证流程
  - 先发送验证码
  - 验证通过后才创建用户
  - 设置 `emailVerified = now()`

**验收标准**:
- 验证码发送成功
- 60秒内重复发送被拒绝
- 过期验证码无法使用
- 注册必须先验证邮箱

---

### Mission 3: 忘记密码 API 实现
**预计时间**: 1-2小时
**目标**: 实现通过邮箱重置密码的完整流程

**任务清单**:
- [ ] 创建 API: `auth.sendResetCode` - 发送重置密码验证码
  - 验证邮箱是否已注册
  - 60秒发送频率限制
  - 生成6位随机码
- [ ] 创建 API: `auth.resetPasswordWithCode` - 使用验证码重置密码
  - 验证邮箱和验证码
  - 更新密码（bcrypt hash）
  - 标记验证码已使用
- [ ] 添加密码强度验证（至少8位，包含字母和数字）

**验收标准**:
- 未注册邮箱提示"该邮箱未注册"
- 验证码正确可重置密码
- 新密码符合强度要求

---

### Mission 4: 前端注册流程改造
**预计时间**: 2-3小时
**目标**: 改造注册页面，实现两步验证注册

**任务清单**:
- [ ] 修改 `/register` 页面为两步流程:
  - Step 1: 输入邮箱 → 发送验证码
  - Step 2: 输入验证码 + 密码 → 完成注册
- [ ] 添加验证码输入组件（6位数字输入框）
- [ ] 添加倒计时重新发送按钮（60秒）
- [ ] 添加加载状态和错误提示
- [ ] 密码强度提示 UI

**验收标准**:
- 注册流程清晰，用户体验流畅
- 验证码输入方便（支持粘贴）
- 错误提示明确

---

### Mission 5: 前端忘记密码流程实现
**预计时间**: 1-2小时
**目标**: 实现完整的忘记密码页面

**任务清单**:
- [ ] 修改 `/forgot-password` 页面为两步流程:
  - Step 1: 输入邮箱 → 发送验证码
  - Step 2: 输入验证码 + 新密码 → 重置成功
- [ ] 复用验证码输入组件
- [ ] 重置成功后自动跳转登录页
- [ ] 添加返回登录链接

**验收标准**:
- 忘记密码流程完整可用
- 重置成功提示清晰
- 可正常使用新密码登录

---

### Mission 6: 安全增强与测试
**预计时间**: 1-2小时
**目标**: 增加安全措施并进行完整测试

**任务清单**:
- [ ] 添加验证码发送频率限制（防刷）
- [ ] 验证码错误次数限制（5次锁定30分钟）
- [ ] Cookie 安全属性增强 (HttpOnly, Secure, SameSite)
- [ ] 清理过期的验证码记录（定时任务或登录时清理）
- [ ] 完整流程测试:
  - 新用户注册流程
  - 已有用户忘记密码流程
  - 各种错误场景测试
- [ ] 更新文档

**验收标准**:
- 无法暴力破解验证码
- Cookie 安全属性正确设置
- 所有流程测试通过

---

## 进度追踪

| Mission | 状态 | 开始时间 | 完成时间 |
|---------|------|----------|----------|
| 1. Resend 集成 | ✅ 完成 | 2026-01-11 | 2026-01-11 |
| 2. 邮箱验证 API | ⏳ 待开始 | - | - |
| 3. 忘记密码 API | ⏳ 待开始 | - | - |
| 4. 前端注册改造 | ⏳ 待开始 | - | - |
| 5. 前端忘记密码 | ⏳ 待开始 | - | - |
| 6. 安全增强测试 | ⏳ 待开始 | - | - |

## 预计总工时
8-14 小时

## 依赖项
- Resend 账号和 API Key
- 发件邮箱域名（或使用 Resend 默认域名测试）
